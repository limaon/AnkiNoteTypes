<div class="prettify-flashcard">
  {{#Tags}}
  <div class="prettify-tags">{{clickable:Tags}}</div>
  {{/Tags}}
  <div class="prettify-field prettify-field--front">{{edit:EnunciadoQuestao}}</div>

  {{#Imagem}}
  <details class="imagem-container">
    <summary class="imagem-label">Imagem</summary>
    <div class="imagem-conteudo">{{Imagem}}</div>
  </details>
  {{/Imagem}}

  <hr class="prettify-divider prettify-divider--answer" id="answer" />

  <!-- Elemento oculto com gabarito para acesso via JavaScript -->
  <span data-gabarito="{{Gabarito}}" style="display:none;"></span>

  <div class="alternativas-container alternativas-verso">
    {{#Alternativa-A}}
    <label class="alternativa-item" data-letra="A">
      <input type="radio" name="resposta-questao" value="A" class="alternativa-radio" disabled>
      <span class="alternativa-letra">A</span>
      <span class="alternativa-texto">{{Alternativa-A}}</span>
    </label>
    {{/Alternativa-A}}
    {{#Alternativa-B}}
    <label class="alternativa-item" data-letra="B">
      <input type="radio" name="resposta-questao" value="B" class="alternativa-radio" disabled>
      <span class="alternativa-letra">B</span>
      <span class="alternativa-texto">{{Alternativa-B}}</span>
    </label>
    {{/Alternativa-B}}
    {{#Alternativa-C}}
    <label class="alternativa-item" data-letra="C">
      <input type="radio" name="resposta-questao" value="C" class="alternativa-radio" disabled>
      <span class="alternativa-letra">C</span>
      <span class="alternativa-texto">{{Alternativa-C}}</span>
    </label>
    {{/Alternativa-C}}
    {{#Alternativa-D}}
    <label class="alternativa-item" data-letra="D">
      <input type="radio" name="resposta-questao" value="D" class="alternativa-radio" disabled>
      <span class="alternativa-letra">D</span>
      <span class="alternativa-texto">{{Alternativa-D}}</span>
    </label>
    {{/Alternativa-D}}
    {{#Alternativa-E}}
    <label class="alternativa-item" data-letra="E">
      <input type="radio" name="resposta-questao" value="E" class="alternativa-radio" disabled>
      <span class="alternativa-letra">E</span>
      <span class="alternativa-texto">{{Alternativa-E}}</span>
    </label>
    {{/Alternativa-E}}
    <!-- JavaScript adicionarÃ¡ classes: alternativa-correta, alternativa-acertou, alternativa-errada -->
  </div>

  {{#Anotacoes}}
  <details class="anotacoes-container anotacoes-verso">
    <summary class="anotacoes-label">AnotaÃ§Ãµes</summary>
    <div class="anotacoes-conteudo">{{Anotacoes}}</div>
  </details>
  {{/Anotacoes}}

  <footer>
    {{#EnunciadoQuestao}}
    <a href="https://www.youtube.com/results?search_query={{EnunciadoQuestao}}" title="Youtube videos">Youtube</a>
    <a href="https://duckduckgo.com/?t=ffab&q={{EnunciadoQuestao}}&ia=web" title="Search on web">DuckDuckGo</a>
    <a href="https://duckduckgo.com/?t=ffab&q={{EnunciadoQuestao}}+site%3Aqconcursos.com+intext%3AQuestÃµes&t=ffab&ia=web"
      title="Questoes">Qconcusos</a>
    <a href="https://duckduckgo.com/?t=ffab&q={{EnunciadoQuestao}}&iax=images&ia=images" title="Search Images">Images</a>
    <a href="https://chatgpt.com/?temporary-chat=true&model=gpt-4o&q={{EnunciadoQuestao}}" title="Search on ChatGPT">GPT-4o</a>
    <a href="https://chatgpt.com/?temporary-chat=true&model=o1&q={{EnunciadoQuestao}}" title="Search on ChatGPT">GPT-o1</a>
    <a href="https://you.com/search?q={{EnunciadoQuestao}}&fromSearchBar=true&tbm=youchat&chatMode=default" title="Search on Phind">YouAI</a>
    {{/EnunciadoQuestao}}
  </footer>

</div>

<script>
  // Split hierarchical tags
  var tagsContainerEl = document.querySelectorAll('.prettify-tags > *')
  if (tagsContainerEl.length > 0) {
    var tags = []
    tagsContainerEl.forEach((tagEl) => {
      tagEl.classList.add('prettify-tag')
      tags.push(tagEl.innerHTML)
      tags.forEach((tag) => {
        var childTag = tag.split('::').filter(Boolean)
        tagEl.innerHTML = childTag[childTag.length - 1].trim()
      })
    })
  } else {
    tagsContainerEl = document.querySelector('.prettify-tags')
    var tags = tagsContainerEl.innerHTML.split(' ').filter(Boolean)
    var html = ''
    tags.forEach((tag) => {
      var childTag = tag.split('::').filter(Boolean)
      html +=
        "<span class='prettify-tag'>" +
        childTag[childTag.length - 1] +
        '</span>'
    })
    tagsContainerEl.innerHTML = html
  }
</script>

<script>
  // Random colors for bold text;
  var randomIndex = Math.floor(Math.random() * 9 + 1);
  var randomColor = "var(--color-" + randomIndex + ")";
  document.documentElement.style.setProperty("--random-color", randomColor);
</script>

<script>
// ComparaÃ§Ã£o e feedback no verso do card
// Este script sÃ³ executa quando o Back.html Ã© renderizado (apÃ³s clicar em "Show Answer")
// A seleÃ§Ã£o do usuÃ¡rio Ã© obtida do localStorage, que foi salva no Front.html
(function() {
  console.log('ğŸŸ¢ [BACK] Script de comparaÃ§Ã£o iniciado');

  // Obter gabarito de elemento oculto ou data attribute
  const gabaritoEl = document.querySelector('[data-gabarito]');
  let gabaritoTexto = gabaritoEl
    ? gabaritoEl.getAttribute('data-gabarito').trim()
    : null;

  console.log('ğŸŸ¢ [BACK] Gabarito (texto completo):', gabaritoTexto);

  if (!gabaritoTexto) {
    console.warn('ğŸŸ¢ [BACK] âš ï¸ Gabarito nÃ£o encontrado');
    return; // Se nÃ£o houver gabarito, nÃ£o fazer nada
  }

  // Normalizar gabarito: pode vir como texto completo ou apenas letra
  // Tenta extrair a letra (A, B, C, D, E) do gabarito
  let gabarito = null;

  // Se o gabarito jÃ¡ Ã© uma letra Ãºnica (A, B, C, D, E)
  if (/^[A-E]$/i.test(gabaritoTexto.trim())) {
    gabarito = gabaritoTexto.trim().toUpperCase();
    console.log('ğŸŸ¢ [BACK] Gabarito Ã© uma letra:', gabarito);
  } else {
    // Se o gabarito Ã© texto completo, precisa encontrar qual alternativa corresponde
    // Compara o texto do gabarito com o texto de cada alternativa
    const alternativas = document.querySelectorAll('.alternativa-item');
    console.log('ğŸŸ¢ [BACK] Procurando alternativa correspondente ao texto do gabarito...');

    alternativas.forEach(item => {
      const textoAlternativa = item.querySelector('.alternativa-texto')?.textContent?.trim() || '';
      const letraAlternativa = item.getAttribute('data-letra');

      // Compara textos (case-insensitive, remove espaÃ§os extras)
      const textoGabaritoNormalizado = gabaritoTexto.trim().toUpperCase().replace(/\s+/g, ' ');
      const textoAlternativaNormalizado = textoAlternativa.trim().toUpperCase().replace(/\s+/g, ' ');

      // Verifica se o texto do gabarito contÃ©m o texto da alternativa ou vice-versa
      if (textoGabaritoNormalizado === textoAlternativaNormalizado ||
          textoGabaritoNormalizado.includes(textoAlternativaNormalizado) ||
          textoAlternativaNormalizado.includes(textoGabaritoNormalizado)) {
        gabarito = letraAlternativa.toUpperCase();
        console.log('ğŸŸ¢ [BACK] âœ… Alternativa correspondente encontrada:', letraAlternativa, '-', textoAlternativa.substring(0, 50) + '...');
      }
    });

    if (!gabarito) {
      console.warn('ğŸŸ¢ [BACK] âš ï¸ NÃ£o foi possÃ­vel encontrar a letra correspondente ao gabarito');
      console.warn('ğŸŸ¢ [BACK] Texto do gabarito:', gabaritoTexto);
      return;
    }
  }

  console.log('ğŸŸ¢ [BACK] Gabarito normalizado (letra):', gabarito);

  // Obter alternativa selecionada pelo usuÃ¡rio do localStorage (salva no Front)
  // Usa a chave mais recente ou busca a Ãºltima chave salva
  let respostaUsuario = null;

  // Primeiro, tenta usar a referÃªncia Ã  chave mais recente
  const chaveMaisRecente = localStorage.getItem('anki-resposta-mais-recente');
  let storedAnswer = null;
  let storageKey = null;

  if (chaveMaisRecente) {
    storageKey = chaveMaisRecente;
    storedAnswer = localStorage.getItem(chaveMaisRecente);
    console.log('ğŸŸ¢ [BACK] Usando chave mais recente:', chaveMaisRecente);
  } else {
    // Se nÃ£o houver referÃªncia, busca a chave mais recente por timestamp
    const allStorageKeys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('anki-resposta-selecionada-')) {
        allStorageKeys.push(key);
      }
    }

    if (allStorageKeys.length > 0) {
      // Ordena por timestamp (nÃºmero apÃ³s o prefixo) e pega a mais recente
      allStorageKeys.sort((a, b) => {
        const timestampA = parseInt(a.replace('anki-resposta-selecionada-', ''));
        const timestampB = parseInt(b.replace('anki-resposta-selecionada-', ''));
        return timestampB - timestampA; // Mais recente primeiro
      });
      storageKey = allStorageKeys[0];
      storedAnswer = localStorage.getItem(storageKey);
      console.log('ğŸŸ¢ [BACK] Chave mais recente encontrada:', storageKey);
    }
  }

  console.log('ğŸŸ¢ [BACK] Chave do localStorage:', storageKey);
  console.log('ğŸŸ¢ [BACK] Resposta armazenada:', storedAnswer);

  if (storedAnswer) {
    respostaUsuario = storedAnswer.trim().toUpperCase();
    console.log('ğŸŸ¢ [BACK] âœ… Resposta do usuÃ¡rio encontrada:', respostaUsuario);

    // Marcar o radio button correspondente como checked (para manter a seleÃ§Ã£o visual)
    const radioCorrespondente = document.querySelector(`.alternativa-radio[value="${respostaUsuario}"]`);
    if (radioCorrespondente) {
      radioCorrespondente.checked = true;
      console.log('ğŸŸ¢ [BACK] âœ… Radio button marcado como checked:', respostaUsuario);
    } else {
      console.warn('ğŸŸ¢ [BACK] âš ï¸ Radio button nÃ£o encontrado para:', respostaUsuario);
    }
  } else {
    console.warn('ğŸŸ¢ [BACK] âš ï¸ Nenhuma resposta encontrada no localStorage');
  }

  // Marcar alternativa correta (sempre verde, independente da escolha do usuÃ¡rio)
  const alternativaCorreta = document.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
  if (alternativaCorreta) {
    alternativaCorreta.classList.add('alternativa-correta');
    console.log('ğŸŸ¢ [BACK] âœ… Alternativa correta marcada (verde):', gabarito);
  } else {
    console.warn('ğŸŸ¢ [BACK] âš ï¸ Elemento da alternativa correta nÃ£o encontrado:', gabarito);
  }

  // Comparar e adicionar feedback baseado na escolha do usuÃ¡rio
  if (respostaUsuario) {
    console.log('ğŸŸ¢ [BACK] Comparando:', respostaUsuario, '===', gabarito);
    if (respostaUsuario === gabarito) {
      // UsuÃ¡rio acertou - adicionar classe de acerto na alternativa correta
      if (alternativaCorreta) {
        alternativaCorreta.classList.add('alternativa-acertou');
        console.log('ğŸŸ¢ [BACK] âœ…âœ…âœ… USUÃRIO ACERTOU!');
      }
    } else {
      // UsuÃ¡rio errou - marcar a alternativa selecionada como errada (vermelho)
      const alternativaErrada = document.querySelector(`.alternativa-item[data-letra="${respostaUsuario}"]`);
      if (alternativaErrada) {
        alternativaErrada.classList.add('alternativa-errada');
        console.log('ğŸŸ¢ [BACK] âŒâŒâŒ USUÃRIO ERROU! Resposta correta:', gabarito, '| Resposta do usuÃ¡rio:', respostaUsuario);
      } else {
        console.warn('ğŸŸ¢ [BACK] âš ï¸ Elemento da alternativa errada nÃ£o encontrado:', respostaUsuario);
      }
      // A alternativa correta jÃ¡ estÃ¡ marcada como verde acima
    }
  } else {
    // UsuÃ¡rio nÃ£o selecionou nada - apenas mostrar a correta em verde
    console.log('ğŸŸ¢ [BACK] â„¹ï¸ UsuÃ¡rio nÃ£o selecionou nenhuma alternativa');
  }

  console.log('ğŸŸ¢ [BACK] Script de comparaÃ§Ã£o finalizado');
})();
</script>


<script>
  // Zoom de imagens: clicar para ampliar, clicar novamente para desampliar
  // Usa event delegation para funcionar mesmo quando o DOM Ã© atualizado (navegaÃ§Ã£o entre cards)
  // FunÃ§Ã£o global que funciona tanto no front quanto no back
  (function() {
    // Verifica se jÃ¡ existe um handler global (evita duplicaÃ§Ã£o)
    if (!window.imageZoomHandler) {
      window.imageZoomHandler = function(e) {
        // Verifica se o clique foi em uma imagem dentro do flashcard
        if (e.target && e.target.tagName === 'IMG' && e.target.closest('.prettify-flashcard')) {
          e.target.classList.toggle('zoomed');
        }
      };

      // Anexa o listener com capture para garantir que funcione em todos os contextos
      document.addEventListener('click', window.imageZoomHandler, true);
    }
  })();
</script>
