<!-- Card 2_TYPE - Back Template -->
<!-- Shows typed solution + suggested solution with comparison -->

<!-- ============================================
     FONTS - JetBrains Mono
     ============================================ -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<!-- ============================================
     ACE EDITOR CDN
     ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_light_default.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_dark.js" charset="utf-8"></script>

<!-- ============================================
     JSDIFF CDN - Text differencing library
     ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/8.0.2/diff.min.js" charset="utf-8"></script>

<!-- Header Section -->
{{#Tags}}
<div class="tags">
  {{clickable:Tags}}
</div>
{{/Tags}}

<!-- Main Content -->
<main class="card-content">
  <!-- Description -->
  <div class="field field-description">
    <h2>Description</h2>
    {{Description}}
  </div>

  <!-- Hint / Further Description (MESMO grid do Front) -->
  {{#Hint}}
  <details class="conditional-section">
    <summary>
      {{#Further Description}}Hint / Further Description{{/Further Description}}
      {{^Further Description}}Hint{{/Further Description}}
    </summary>
    <div class="conditional-content">
      <!-- Hint / Further Grid (MESMO do Front) -->
      <div class="hint-further-grid">
        <!-- Hint -->
        <div class="grid-item">
          <div class="field field-hint">
            <h3>Hint</h3>
            <code class="language-{{Language}}">{{Hint}}</code>
          </div>
        </div>
        <!-- Further Description (if present) -->
        {{#Further Description}}
        <div class="grid-item">
          <div class="field field-further">
            <h3>Further Description (Output)</h3>
            <code class="language-{{Language}}">{{Further Description}}</code>
          </div>
        </div>
        {{/Further Description}}
      </div>
    </div>
  </details>
  {{/Hint}}

  <!-- Solution Comparison Grid -->
  <div class="solution-comparison">
    <div class="solution-grid">
      <!-- Your Solution (Diff highlighting) -->
      <div class="grid-item">
        <h3>Your Solution</h3>
        <div id="diff-result" class="diff-result">
          <!-- Resultado do diff será inserido via JavaScript -->
        </div>
      </div>
      <!-- Correct Answer (Ace Editor) -->
      <div class="grid-item">
        <h3>Correct Answer</h3>
        <div id="correct-solution" class="ace-editor-container">{{Code}}</div>
      </div>
    </div>
  </div>

  <!-- Info Section -->
  <details class="conditional-section">
    <summary>Info</summary>
    <div class="conditional-content info-content">
      <h3>Submitting your answer</h3>
      <p>Your answer was saved automatically as you typed.</p>

      <h3>Diff Markup Meaning</h3>
      <p><span class="diff-correct">■ Correct</span> Characters you typed correctly</p>
      <p><span class="diff-missed">■ Missed</span> Characters you forgot to type</p>
      <p><span class="diff-extra">■ Extra</span> Characters you typed that don't belong</p>
    </div>
  </details>

  <!-- Source (Conditional) -->
  {{#Source}}
  <div class="footer">
    <div class="footer-links">
      <span class="footer-links-label">Learn More:</span>
      <a href="https://www.youtube.com/results?search_query={{Source}}" target="_blank" class="footer-link" title="Search on YouTube">
        YouTube
      </a>
      <span class="footer-link-separator">|</span>
      <a href="https://stackoverflow.com/search?q={{Source}}" target="_blank" class="footer-link" title="Search on StackOverflow">
        StackOverflow
      </a>
      <span class="footer-link-separator">|</span>
      <a href="https://duckduckgo.com/?q={{Source}}" target="_blank" class="footer-link" title="Search on DuckDuckGo">
        DuckDuckGo
      </a>
    </div>
  </div>
  {{/Source}}


</main>


<script>
// ============================================
//   CONFIGURAÇÃO
//   ============================================

// Tag configuration
var TagConfig = {
  levelsToShow: 1  // 0=full, 1=last part, 2=last 2 parts
};

// ============================================
//   LANGUAGE MAPPING
//   ============================================

var LanguageMap = {
  // Scripting languages
  'python': 'python',
  'py': 'python',
  'javascript': 'javascript',
  'js': 'javascript',
  'typescript': 'typescript',
  'ts': 'typescript',
  'ruby': 'ruby',
  'php': 'php',
  'perl': 'perl',

  // Compiled languages
  'java': 'java',
  'c': 'c_cpp',
  'cpp': 'c_cpp',
  'c++': 'c_cpp',
  'c#': 'csharp',
  'csharp': 'csharp',
  'go': 'golang',
  'golang': 'golang',
  'rust': 'rust',
  'swift': 'swift',
  'kotlin': 'kotlin',
  'scala': 'scala',

  // Functional languages
  'haskell': 'haskell',
  'erlang': 'erlang',
  'elixir': 'elixir',
  'clojure': 'clojure',
  'f#': 'fsharp',
  'fsharp': 'fsharp',

  // Markup & Data
  'html': 'html',
  'xml': 'xml',
  'json': 'json',
  'yaml': 'yaml',
  'yml': 'yaml',
  'toml': 'toml',
  'markdown': 'markdown',
  'md': 'markdown',

  // Styles
  'css': 'css',
  'scss': 'scss',
  'sass': 'sass',
  'less': 'less',

  // Configuration & Shells
  'bash': 'sh',
  'shell': 'sh',
  'powershell': 'powershell',
  'dockerfile': 'dockerfile',
  'docker': 'dockerfile',

  // Databases
  'sql': 'sql',
  'mysql': 'sql',
  'postgresql': 'sql',
  'sqlite': 'sql',
  'mongodb': 'javascript',

  // Other
  'r': 'r',
  'lua': 'lua',
  'matlab': 'matlab',
  'groovy': 'groovy',
  'dart': 'dart'
};

// ============================================
//   UTILITY FUNCTIONS
//   ============================================

var Utils = {
  getAceMode: function(language) {
    var langLower = (language || '').toLowerCase().trim();
    return LanguageMap[langLower] || 'text';
  },

  getTheme: function() {
    var body = document.body;
    if (body && (body.classList.contains('night_mode') ||
                 document.documentElement.classList.contains('night_mode'))) {
      return 'ace/theme/github_dark';
    }
    return 'ace/theme/github_light_default';
  },

  escapeHtml: function(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

// ============================================
//   EDITOR CONFIGURATION
//   ============================================

// Editor configuration (base)
var EditorConfig = {
  options: {
    readOnly: true,
    showPrintMargin: false,
    highlightActiveLine: false,
    behavioursEnabled: false,
    fontSize: '16px',
    fontFamily: 'JetBrains Mono, monospace'
  },
  scroll: {
    top: 1,
    bottom: 1,
    left: 0,
    right: 0
  },
  resize: {
    minHeight: 336,
    maxHeight: 336,
    lineHeight: 28
  }
};

// ============================================
//   EDITOR CONFIGURATOR
//   ============================================

// Editor configuration functions
var EditorConfigurator = {
  configure: function(editor, language, customConfig) {
    if (!editor) return;

    var config = customConfig || EditorConfig;  // Usa customConfig ou o padrão

    this.applyOptions(editor, config.options);
    this.applyTheme(editor);
    this.applySyntax(editor, language);
    this.applyScrollMargin(editor, config.scroll);
  },

  applyOptions: function(editor, options) {
    editor.setOptions(options);
  },

  applyTheme: function(editor) {
    editor.setTheme(Utils.getTheme());
  },

  applySyntax: function(editor, language) {
    var mode = Utils.getAceMode(language);
    editor.session.setMode('ace/mode/' + mode);
  },

  applyScrollMargin: function(editor, scrollConfig) {
    editor.renderer.setScrollMargin(
      scrollConfig.top,
      scrollConfig.bottom,
      scrollConfig.left,
      scrollConfig.right
    );
  }
};

// ============================================
//   EDITOR RESIZER
//   ============================================

// Editor resize function
var EditorResizer = {
  resize: function(editor, customConfig) {
    if (!editor) return;

    var config = customConfig || EditorConfig;  // Usa customConfig ou o padrão
    var session = editor.getSession();
    var lineCount = session.getLength();

    var newHeight = Math.max(
      config.resize.minHeight,
      Math.min(config.resize.maxHeight, lineCount * config.resize.lineHeight)
    );

    editor.container.style.height = newHeight + 'px';
    editor.resize();
  }
};

// ============================================
//   TAG SPLITTING
//   Processa tags hierárquicas e exibe apenas partes relevantes
//   ============================================
(function() {
  var tagsContainer = document.querySelector('.tags');

  if (!tagsContainer) {
    return;
  }

  var tagText = tagsContainer.textContent || tagsContainer.innerText;
  tagText = tagText.trim();

  if (!tagText) {
    return;
  }

  var tags = tagText.split(/\s+/).filter(Boolean);

  if (tags.length === 0) {
    return;
  }

  var html = '';
  tags.forEach(function(tag) {
    var displayName = tag;
    var parts = tag.split('::');

    if (TagConfig.levelsToShow > 0 && parts.length > TagConfig.levelsToShow) {
      displayName = parts.slice(-TagConfig.levelsToShow).join('::');
    }

    html += '<span class="tag">' + displayName + '</span>';
  });

  tagsContainer.innerHTML = html;
})();

// ============================================
//   JSDIFF - Diff Generation
//   ============================================

var DiffGenerator = {
  /**
   * Escape HTML special characters to prevent XSS
   * @param {string} text - Text to escape
   * @returns {string} Escaped text
   */
  escapeHtml: function(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },

  /**
   * Generate HTML with diff highlighting using jsdiff
   * @param {string} expected - The correct/expected code
   * @param {string} actual - The user's input code
   * @returns {string} HTML string with diff highlighting
   */
  generateDiffHtml: function(expected, actual) {
    // Handle empty inputs
    if (!actual || actual.trim() === '') {
      return '<span class="diff-missed">' + this.escapeHtml(expected) + '</span>';
    }

    if (!expected || expected.trim() === '') {
      return '<span class="diff-extra">' + this.escapeHtml(actual) + '</span>';
    }

    // Use jsdiff to compute character-level diff
    var diff = Diff.diffChars(expected, actual);
    var html = '';

    diff.forEach(function(part) {
      // Determine CSS class based on diff type
      var className = part.added ? 'diff-extra' :    // User typed extra characters
                      part.removed ? 'diff-missed' : // User missed these characters
                      'diff-correct';                // Correct match

      // Escape HTML and preserve line breaks
      var escapedValue = DiffGenerator.escapeHtml(part.value);

      html += '<span class="' + className + '">' + escapedValue + '</span>';
    });

    return html;
  }
};

// ============================================
//   ACE EDITOR FOR BACK (COMPARISON)
//   ============================================

(function() {
  'use strict';

  var correctSolutionElement = document.getElementById('correct-solution');
  var diffResultElement = document.getElementById('diff-result');

  if (!correctSolutionElement) {
    return;
  }

  // Load user's input from sessionStorage
  var userInput = sessionStorage.getItem('input_transfer_front');

  // Clear to avoid carrying over to next card
  sessionStorage.removeItem('input_transfer_front');

  // Get correct code from the element (before Ace Editor transforms it)
  var correctCode = correctSolutionElement.textContent || correctSolutionElement.innerText || '';

  // Get language for Ace Editor
  var language = '{{Language}}' || 'text';

  // ============================================
  //   GENERATE DIFF RESULT
  // ============================================
  if (diffResultElement) {
    try {
      var diffHtml = DiffGenerator.generateDiffHtml(correctCode, userInput || '');
      diffResultElement.innerHTML = diffHtml;
    } catch (error) {
      diffResultElement.innerHTML = '<span class="diff-error">Failed to generate diff comparison.</span>';
    }
  }

  // Initialize Ace Editor (Correct Solution)
  try {
    var editorCorrect = ace.edit('correct-solution');
    EditorConfigurator.configure(editorCorrect, language);
    editorCorrect.setOption('readOnly', true);
    EditorResizer.resize(editorCorrect);

    var originalTheme = Utils.getTheme();
    window.addEventListener('resize', function() {
      EditorResizer.resize(editorCorrect);
      var newTheme = Utils.getTheme();
      if (newTheme !== originalTheme) {
        EditorConfigurator.applyTheme(editorCorrect);
        originalTheme = newTheme;
      }
    });
  } catch (error) {
    // Fallback: keep raw code visible
  }
})();
</script>
