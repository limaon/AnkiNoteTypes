<!-- Card 2_TYPE - Front Template -->
<!-- Interactive typing practice card -->

<!-- ============================================
     FONTS - JetBrains Mono
     ============================================ -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Header Section -->
{{#Tags}}
<div class="tags">
  {{clickable:Tags}}
</div>
{{/Tags}}

<!-- Main Content -->
<main class="card-content">
  <!-- Description -->
  <div class="field field-description">
    <h2>Description</h2>
    {{Description}}
  </div>

  <!-- Hint / Further Description (Conditional) -->
  {{#Hint}}
  <details class="conditional-section">
    <summary>
      {{#Further Description}}Hint / Further Description{{/Further Description}}
      {{^Further Description}}Hint{{/Further Description}}
    </summary>
    <div class="conditional-content">
      <!-- Hint / Further Grid -->
      <div class="hint-further-grid">
        <!-- Hint -->
        <div class="grid-item">
          <div class="field field-hint">
            <h3>Hint</h3>
            <code class="language-{{Language}}">{{Hint}}</code>
          </div>
        </div>
        <!-- Further Description (if present) -->
        {{#Further Description}}
        <div class="grid-item">
          <div class="field field-further">
            <h3>Further Description (Output)</h3>
            <code class="language-{{Language}}">{{Further Description}}</code>
          </div>
        </div>
        {{/Further Description}}
      </div>
    </div>
  </details>
  {{/Hint}}

  <!-- Your Solution (Ace Editor) -->
  <div class="typing-section">
    <h2>Your Solution</h2>
    <!-- Ace Editor Container - Vazio (para digitação) -->
    <div id="ace-editor-type" class="ace-editor-container"></div>
    <!-- Hidden textarea para Anki -->
    <textarea id="typeans" name="typeans" style="display: none;"></textarea>
    <div class="typing-hint">
      Press Tab for indentation. Your solution is automatically saved.
    </div>
  </div>

  <!-- Editor Settings Section -->
  <details class="conditional-section" id="editor-settings">
    <summary>Editor Settings</summary>
    <div class="conditional-content settings-content settings-inline">
      <!-- Autocomplete Toggle -->
      <label class="setting-toggle">
        <span class="setting-label">Autocomplete</span>
        <input type="checkbox" id="setting-autocomplete" checked>
        <span class="toggle-slider-mini"></span>
      </label>

      <!-- Indent Guides Toggle -->
      <label class="setting-toggle">
        <span class="setting-label">Indent Guides</span>
        <input type="checkbox" id="setting-indent-guides">
        <span class="toggle-slider-mini"></span>
      </label>

      <!-- Keybindings Radio -->
      <div class="setting-keybindings">
        <label class="radio-option-mini">
          <input type="radio" name="keybinding" value="default">
          <span>Default</span>
        </label>
        <label class="radio-option-mini">
          <input type="radio" name="keybinding" value="vim" checked>
          <span>Vim</span>
        </label>
        <label class="radio-option-mini">
          <input type="radio" name="keybinding" value="emacs">
          <span>Emacs</span>
        </label>
      </div>
    </div>
  </details>

  <!-- Info Section -->
  <details class="conditional-section">
    <summary>Info</summary>
    <div class="conditional-content info-content">
      <h3>Submitting your answer</h3>
      <p>Your answer will be saved automatically as you type. To compare with the suggested solution, press "Show Answer" or exit the text field and press Space.</p>

      <h3>Markup Meaning</h3>
      <p><span class="correct-indicator">Correct Characters</span> Text typed correctly</p>
      <p><span class="missed-indicator">Missed Characters</span> Text not typed</p>
      <p><span class="extra-indicator">False Characters</span> Text that doesn't belong</p>
    </div>
  </details>
</main>

 <!-- ============================================
      ACE EDITOR CDN (Load before initialization)
      ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_light_default.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_dark.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ext-language_tools.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/keybinding-vim.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/keybinding-emacs.js" charset="utf-8"></script>

<script>
// ============================================
//   CONFIGURAÇÃO
//   ============================================

// Tag configuration
var TagConfig = {
  levelsToShow: 1  // 0=full, 1=last part, 2=last 2 parts
};

// ============================================
//   LANGUAGE MAPPING
//   ============================================

var LanguageMap = {
  // Scripting languages
  'python': 'python',
  'py': 'python',
  'javascript': 'javascript',
  'js': 'javascript',
  'typescript': 'typescript',
  'ts': 'typescript',
  'ruby': 'ruby',
  'php': 'php',
  'perl': 'perl',

  // Compiled languages
  'java': 'java',
  'c': 'c_cpp',
  'cpp': 'c_cpp',
  'c++': 'c_cpp',
  'c#': 'csharp',
  'csharp': 'csharp',
  'go': 'golang',
  'golang': 'golang',
  'rust': 'rust',
  'swift': 'swift',
  'kotlin': 'kotlin',
  'scala': 'scala',

  // Functional languages
  'haskell': 'haskell',
  'erlang': 'erlang',
  'elixir': 'elixir',
  'clojure': 'clojure',
  'f#': 'fsharp',
  'fsharp': 'fsharp',

  // Markup & Data
  'html': 'html',
  'xml': 'xml',
  'json': 'json',
  'yaml': 'yaml',
  'yml': 'yaml',
  'toml': 'toml',
  'markdown': 'markdown',
  'md': 'markdown',

  // Styles
  'css': 'css',
  'scss': 'scss',
  'sass': 'sass',
  'less': 'less',

  // Configuration & Shells
  'bash': 'sh',
  'shell': 'sh',
  'powershell': 'powershell',
  'dockerfile': 'dockerfile',
  'docker': 'dockerfile',

  // Databases
  'sql': 'sql',
  'mysql': 'sql',
  'postgresql': 'sql',
  'sqlite': 'sql',
  'mongodb': 'javascript',

  // Other
  'r': 'r',
  'lua': 'lua',
  'matlab': 'matlab',
  'groovy': 'groovy',
  'dart': 'dart'
};

// ============================================
//   UTILITY FUNCTIONS
//   ============================================

var Utils = {
  getAceMode: function(language) {
    var langLower = (language || '').toLowerCase().trim();
    return LanguageMap[langLower] || 'text';
  },

  getTheme: function() {
    var body = document.body;
    if (body && (body.classList.contains('night_mode') ||
                 document.documentElement.classList.contains('night_mode'))) {
      return 'ace/theme/github_dark';
    }
    return 'ace/theme/github_light_default';
  },

  escapeHtml: function(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

// ============================================
//   EDITOR CONFIGURATION
//   ============================================

// Editor configuration (base)
var EditorConfig = {
  options: {
    readOnly: true,
    showPrintMargin: false,
    highlightActiveLine: false,
    behavioursEnabled: false,
    fontSize: '16px',
    fontFamily: 'JetBrains Mono, monospace'
  },
  scroll: {
    top: 1,
    bottom: 1,
    left: 0,
    right: 0
  },
  resize: {
    minHeight: 100,
    maxHeight: 400,
    lineHeight: 28
  }
};

// ============================================
//   EDITOR CONFIGURATOR
//   ============================================

// Editor configuration functions
var EditorConfigurator = {
  configure: function(editor, language, customConfig) {
    if (!editor) return;

    var config = customConfig || EditorConfig;  // Usa customConfig ou o padrão

    this.applyOptions(editor, config.options);
    this.applyTheme(editor);
    this.applySyntax(editor, language);
    this.applyScrollMargin(editor, config.scroll);
  },

  applyOptions: function(editor, options) {
    editor.setOptions(options);
  },

  applyTheme: function(editor) {
    editor.setTheme(Utils.getTheme());
  },

  applySyntax: function(editor, language) {
    var mode = Utils.getAceMode(language);
    editor.session.setMode('ace/mode/' + mode);
  },

  applyScrollMargin: function(editor, scrollConfig) {
    editor.renderer.setScrollMargin(
      scrollConfig.top,
      scrollConfig.bottom,
      scrollConfig.left,
      scrollConfig.right
    );
  }
};

// ============================================
//   EDITOR RESIZER
//   ============================================

// Editor resize function
var EditorResizer = {
  resize: function(editor, customConfig) {
    if (!editor) return;

    var config = customConfig || EditorConfig;  // Usa customConfig ou o padrão
    var session = editor.getSession();
    var lineCount = session.getLength();

    var newHeight = Math.max(
      config.resize.minHeight,
      Math.min(config.resize.maxHeight, lineCount * config.resize.lineHeight)
    );

    editor.container.style.height = newHeight + 'px';
    editor.resize();
  }
};

// ============================================
//   TAG SPLITTING
//   Processa tags hierárquicas e exibe apenas partes relevantes
//   ============================================
(function() {
  var tagsContainer = document.querySelector('.tags');

  if (!tagsContainer) {
    return;
  }

  var tagText = tagsContainer.textContent || tagsContainer.innerText;
  tagText = tagText.trim();

  if (!tagText) {
    return;
  }

  var tags = tagText.split(/\s+/).filter(Boolean);

  if (tags.length === 0) {
    return;
  }

  var html = '';
  tags.forEach(function(tag) {
    var displayName = tag;
    var parts = tag.split('::');

    if (TagConfig.levelsToShow > 0 && parts.length > TagConfig.levelsToShow) {
      displayName = parts.slice(-TagConfig.levelsToShow).join('::');
    }

    html += '<span class="tag">' + displayName + '</span>';
  });

  tagsContainer.innerHTML = html;
})();

// ============================================
//   CONFIGURAÇÃO DO ACE EDITOR (TYPING)
//   ============================================

// Editor configuration for typing (editable)
var EditorConfigTyping = {
  options: {
    readOnly: false,              // Editável
    showPrintMargin: false,
    highlightActiveLine: false,    // Mostra linha ativa
    behavioursEnabled: true,      // Habilita comportamentos
    fontSize: '16px',
    fontFamily: 'JetBrains Mono, monospace',
    enableBasicAutocompletion: true,   // Autocompletação básica
    enableLiveAutocompletion: true,     // Live autocompletação desativada

      showGutter: true,
    showLineNumbers: true,
    fixedWidthGutter: true,
    showFoldWidgets: false,
    foldStyle: 'markbegin'
  },
  scroll: {
    top: 1,
    bottom: 1,
    left: 0,
    right: 0
  },
  resize: {
    minHeight: 336,              // 15 linhas × 28px = 420px (altura fixa)
    maxHeight: 336,              // Mesma altura = altura fixa
    lineHeight: 28               // Altura de cada linha
  }
};

// ============================================
//   ACE EDITOR FOR TYPING (Editable)
//   ============================================

(function() {
  'use strict';

  var editorContainer = document.getElementById('ace-editor-type');
  var typeansField = document.getElementById('typeans');

  if (!editorContainer || !typeansField) {
    return;
  }

  try {
    // Get language (usar Language do template)
    var language = '{{Language}}' || 'text';

    // Initialize editor
    var editor = ace.edit('ace-editor-type');

    // Enable autocompletion plugin
    ace.require("ace/ext/language_tools");

    // Configure editor (usar configs de typing)
    EditorConfigurator.configure(editor, language, EditorConfigTyping);

    // Auto-resize (usar EditorResizer existente)
    EditorResizer.resize(editor, EditorConfigTyping);

    // Re-check theme on resize
    var originalTheme = Utils.getTheme();
    window.addEventListener('resize', function() {
      EditorResizer.resize(editor, EditorConfigTyping);
      var newTheme = Utils.getTheme();
      if (newTheme !== originalTheme) {
        EditorConfigurator.applyTheme(editor);
        originalTheme = newTheme;
      }
    });

    // ============================================
    //   LOCAL HELPER FUNCTIONS (encapsulated)
    //   ============================================

    // Sincronizar editor com textarea para Anki
    function syncEditorToTextarea(editor, textarea) {
      // Atualizar textarea quando editor mudar
      editor.on('change', function() {
        textarea.value = editor.getValue();
      });

      // Atualizar textarea periodicamente
      editor.on('input', function() {
        textarea.value = editor.getValue();
      });
    }

    // Auto-save com sessionStorage
    function implementAutoSave(editor, textarea) {
      var saveTimeout = null;

      // Carregar conteúdo salvo
      var savedInput = sessionStorage.getItem('input_transfer_front');
      if (savedInput !== null) {
        editor.setValue(savedInput, -1);  // -1 = move cursor para início
        editor.clearSelection();
      }

      // Salvar com debounce
      function saveInput() {
        var content = editor.getValue();
        sessionStorage.setItem('input_transfer_front', content);
        textarea.value = content;  // Sincronizar
      }

      // Salvar com debounce
      editor.on('change', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveInput, 500);
      });

      // Salvar ao perder foco
      editor.on('blur', saveInput);

      // Space atalho para mostrar resposta
      document.addEventListener('keydown', function(e) {
        if (e.key === ' ' && editor.textInput.getElement() !== document.activeElement) {
          var answerButton = document.querySelector('button.ansbtn');
          if (answerButton) {
            answerButton.click();
          }
        }
      });
    }

    // Sincronizar com textarea para Anki
    syncEditorToTextarea(editor, typeansField);

    // Auto-save com sessionStorage
    implementAutoSave(editor, typeansField);

    // ============================================
    //   EDITOR SETTINGS MANAGEMENT
    //   ============================================

    var EditorSettings = {
      storageKey: 'ace_editor_settings',

      defaults: {
        autocomplete: true,
        indentGuides: false,
        keybinding: 'vim'
      },

      load: function() {
        try {
          var saved = localStorage.getItem(this.storageKey);
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (e) {
          // Ignore parse errors
        }
        return this.defaults;
      },

      save: function(settings) {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(settings));
        } catch (e) {
          // Ignore storage errors
        }
      },

      applyToEditor: function(editor, settings) {
        // Autocomplete
        editor.setOptions({
          enableBasicAutocompletion: settings.autocomplete,
          enableLiveAutocompletion: settings.autocomplete
        });

        // Indent Guides
        editor.setOption('displayIndentGuides', settings.indentGuides);

        // Keybindings
        if (settings.keybinding === 'vim') {
          editor.setKeyboardHandler('ace/keyboard/vim');
        } else if (settings.keybinding === 'emacs') {
          editor.setKeyboardHandler('ace/keyboard/emacs');
        } else {
          editor.setKeyboardHandler(null);
        }
      },

      bindUI: function(editor) {
        var self = this;
        var settings = this.load();

        // Get UI elements
        var autocompleteToggle = document.getElementById('setting-autocomplete');
        var indentGuidesToggle = document.getElementById('setting-indent-guides');
        var keybindingRadios = document.querySelectorAll('input[name="keybinding"]');

        // Set initial UI state from saved settings
        if (autocompleteToggle) {
          autocompleteToggle.checked = settings.autocomplete;
        }
        if (indentGuidesToggle) {
          indentGuidesToggle.checked = settings.indentGuides;
        }
        keybindingRadios.forEach(function(radio) {
          radio.checked = (radio.value === settings.keybinding);
        });

        // Apply settings to editor
        this.applyToEditor(editor, settings);

        // Bind change events
        if (autocompleteToggle) {
          autocompleteToggle.addEventListener('change', function() {
            settings.autocomplete = this.checked;
            self.applyToEditor(editor, settings);
            self.save(settings);
          });
        }

        if (indentGuidesToggle) {
          indentGuidesToggle.addEventListener('change', function() {
            settings.indentGuides = this.checked;
            self.applyToEditor(editor, settings);
            self.save(settings);
          });
        }

        keybindingRadios.forEach(function(radio) {
          radio.addEventListener('change', function() {
            if (this.checked) {
              settings.keybinding = this.value;
              self.applyToEditor(editor, settings);
              self.save(settings);
            }
          });
        });
      }
    };

    // Initialize settings UI
    EditorSettings.bindUI(editor);

  } catch (error) {
    console.error('Failed to initialize Ace editor:', error);

    // Fallback: usar textarea básico
    editorContainer.style.display = 'none';
    typeansField.style.display = 'block';
    typeansField.className = 'field field-typing';
  }
})();
</script>
