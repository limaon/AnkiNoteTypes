<!-- Card 1 - Front Template -->
<!-- Simple code display with syntax highlighting -->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Tags -->
{{#Tags}}
<div class="tags">
  {{clickable:Tags}}
</div>
{{/Tags}}

<!-- Language Badge -->
<div class="language-badge">
  <span class="language-text" id="language-badge-text">{{Language}}</span>
</div>


<!-- Main Content -->
<main class="card-content">
  <!-- Code Display -->
  <div class="field field-code">
    <h2>Code</h2>
    <div id="ace-editor" class="ace-editor-container">{{Code}}</div>
  </div>

  <!-- Hint (Conditional) -->
  {{#Hint}}
  <details class="conditional-section">
    <summary>Hint</summary>
    <div class="conditional-content">
      <div class="field field-hint">
        {{Hint}}
      </div>
    </div>
  </details>
  {{/Hint}}
</main>

<!-- ============================================
     ACE EDITOR CDN (Load before initialization)
     ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_light_default.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/theme-github_dark.js" charset="utf-8"></script>

<script>

// ============================================
//   CONFIGURATION
//   ============================================

// Tag configuration
var TagConfig = {
  levelsToShow: 1  // 0=full, 1=last part, 2=last 2 parts
};

// Editor configuration
var EditorConfig = {
  options: {
    readOnly: true,
    showPrintMargin: false,
    highlightActiveLine: false,
    behavioursEnabled: false,
    fontSize: '16px',
    fontFamily: 'JetBrains Mono, monospace'
  },
  scroll: {
    top: 10,
    bottom: 10,
    left: 10,
    right: 10
  },
  resize: {
    minHeight: 100,
    maxHeight: 400,
    lineHeight: 28
  }
};

// Language mapping
var LanguageMap = {
  // Scripting languages
  'python': 'python',
  'py': 'python',
  'javascript': 'javascript',
  'js': 'javascript',
  'typescript': 'typescript',
  'ts': 'typescript',
  'ruby': 'ruby',
  'php': 'php',
  'perl': 'perl',

  // Compiled languages
  'java': 'java',
  'c': 'c_cpp',
  'cpp': 'c_cpp',
  'c++': 'c_cpp',
  'c#': 'csharp',
  'csharp': 'csharp',
  'go': 'golang',
  'golang': 'golang',
  'rust': 'rust',
  'swift': 'swift',
  'kotlin': 'kotlin',
  'scala': 'scala',

  // Functional languages
  'haskell': 'haskell',
  'erlang': 'erlang',
  'elixir': 'elixir',
  'clojure': 'clojure',
  'f#': 'fsharp',
  'fsharp': 'fsharp',

  // Markup & Data
  'html': 'html',
  'xml': 'xml',
  'json': 'json',
  'yaml': 'yaml',
  'yml': 'yaml',
  'toml': 'toml',
  'markdown': 'markdown',
  'md': 'markdown',

  // Styles
  'css': 'css',
  'scss': 'scss',
  'sass': 'sass',
  'less': 'less',

  // Configuration & Shells
  'bash': 'sh',
  'shell': 'sh',
  'powershell': 'powershell',
  'dockerfile': 'dockerfile',
  'docker': 'dockerfile',

  // Databases
  'sql': 'sql',
  'mysql': 'sql',
  'postgresql': 'sql',
  'sqlite': 'sql',
  'mongodb': 'javascript',

  // Other
  'r': 'r',
  'lua': 'lua',
  'matlab': 'matlab',
  'groovy': 'groovy',
  'dart': 'dart'
};

// ============================================
//   TAG SPLITTING
//   ============================================
(function() {
  var tagsContainer = document.querySelector('.tags');

  if (!tagsContainer) {
    return;
  }

  var tagText = tagsContainer.textContent || tagsContainer.innerText;
  tagText = tagText.trim();

  if (!tagText) {
    return;
  }

  var tags = tagText.split(/\s+/).filter(Boolean);

  if (tags.length === 0) {
    return;
  }

  var html = '';
  tags.forEach(function(tag) {
    var displayName = tag;
    var parts = tag.split('::');

    if (TagConfig.levelsToShow > 0 && parts.length > TagConfig.levelsToShow) {
      displayName = parts.slice(-TagConfig.levelsToShow).join('::');
    }

    html += '<span class="tag">' + displayName + '</span>';
  });

  tagsContainer.innerHTML = html;
})();

// ============================================
//   LANGUAGE BADGE
//   ============================================
(function() {
  var langBadge = document.getElementById('language-badge-text');

  if (!langBadge) {
    return;
  }

  var langText = langBadge.textContent || langBadge.innerText;
  langText = langText.trim().toLowerCase();

  langBadge.setAttribute('data-lang', langText);

  var supportedLanguages = [
    'python', 'javascript', 'js', 'typescript', 'ts',
    'java', 'c', 'cpp', 'c++', 'go', 'rust', 'ruby',
    'php', 'html', 'css', 'sql', 'json', 'bash', 'shell',
    'yaml', 'xml', 'markdown', 'docker'
  ];

  if (supportedLanguages.indexOf(langText) === -1) {
    langBadge.setAttribute('data-lang', 'default');
  }
})();

// ============================================
//   ACE EDITOR
//   ============================================

// Utility functions
var Utils = {
  getAceMode: function(language) {
    var langLower = (language || '').toLowerCase().trim();
    return LanguageMap[langLower] || 'text';
  },

  getTheme: function() {
    var body = document.body;
    if (body && (body.classList.contains('night_mode') ||
                 document.documentElement.classList.contains('night_mode'))) {
      return 'ace/theme/github_dark';
    }
    return 'ace/theme/github_light_default';
  },

  escapeHtml: function(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

// Editor configuration functions
var EditorConfigurator = {
  configure: function(editor, language) {
    if (!editor) return;

    this.applyOptions(editor);
    this.applyTheme(editor);
    this.applySyntax(editor, language);
    this.applyScrollMargin(editor);
  },

  applyOptions: function(editor) {
    editor.setOptions(EditorConfig.options);
  },

  applyTheme: function(editor) {
    editor.setTheme(Utils.getTheme());
  },

  applySyntax: function(editor, language) {
    var mode = Utils.getAceMode(language);
    editor.session.setMode('ace/mode/' + mode);
  },

  applyScrollMargin: function(editor) {
    editor.renderer.setScrollMargin(
      EditorConfig.scroll.top,
      EditorConfig.scroll.bottom,
      EditorConfig.scroll.left,
      EditorConfig.scroll.right
    );
  }
};

// Editor resize function
var EditorResizer = {
  resize: function(editor) {
    if (!editor) return;

    var session = editor.getSession();
    var lineCount = session.getLength();

    var newHeight = Math.max(
      EditorConfig.resize.minHeight,
      Math.min(EditorConfig.resize.maxHeight, lineCount * EditorConfig.resize.lineHeight)
    );

    editor.container.style.height = newHeight + 'px';
    editor.resize();
  }
};

// Main initialization
(function() {
  'use strict';

  var editorContainer = document.getElementById('ace-editor');

  if (!editorContainer) {
    return;
  }

  try {
    // Get language
    var languageElement = document.getElementById('language-badge-text');
    var language = languageElement ?
                   (languageElement.textContent || languageElement.innerText).trim() :
                   'text';

    // Initialize editor
    var editor = ace.edit('ace-editor');

    // Configure editor
    EditorConfigurator.configure(editor, language);

    // Auto-resize
    EditorResizer.resize(editor);

    // Re-check theme on resize
    var originalTheme = Utils.getTheme();
    window.addEventListener('resize', function() {
      EditorResizer.resize(editor);

      var newTheme = Utils.getTheme();
      if (newTheme !== originalTheme) {
        EditorConfigurator.applyTheme(editor);
        originalTheme = newTheme;
      }
    });

  } catch (error) {
    console.error('Failed to initialize Ace editor:', error);

    // Fallback
    if (editorContainer) {
      var codeContent = editorContainer.textContent || editorContainer.innerText;
      editorContainer.innerHTML = '<pre style="font-family: monospace; padding: 15px; background: var(--code-background); border-radius: 4px;">' +
                                  Utils.escapeHtml(codeContent) +
                                  '</pre>';
    }
  }
})();

</script>
